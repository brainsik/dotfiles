#!/usr/bin/env bash
set -eu -o pipefail

# See the custom `brew` script that keeps Homebrew happy.

upgrade_casks() {
	brew upgrade --cask --greedy
}

update_formula_service() {
  formula=$1

  set -x
  sudo chown -R "$USER": "$HOMEBREW_PREFIX/Cellar/$formula"
  brew upgrade --formula "$formula"
  sudo -E brew services restart "$formula"
  set +x
}

upgrade_formulae() {
  # services
  set +x
  for svc in $(brew outdated --formula tailscale --formula et | cut -f1); do
    update_formula_service "$(basename "$svc")"
  done

	# everything else
	set -x
	brew upgrade
}

set -x
brew update
brew doctor || read -rp '<enter> to continue'
brew missing || read -rp '<enter> to continue'
upgrade_casks
upgrade_formulae
brew cleanup -s
brew missing || read -rp '<enter> to continue'
brew doctor || read -rp '<enter> to continue'
